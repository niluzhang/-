package net;

import java.net.*;
import java.util.ArrayList;
import java.io.*;

import message.Message;

public class Net {
	
	public Socket 	sock;
	public ObjectInputStream ois;
	public ObjectOutputStream oos;
	public ArrayList<Message> message_list=new ArrayList<Message>();
	
	public Net() throws IOException{                    //调用者根据是否捕获异常判断是否介入网络
			sock=new Socket("127.0.0.1",5000);
			oos=new ObjectOutputStream(sock.getOutputStream());
			ois=new ObjectInputStream(sock.getInputStream());
	}

	public synchronized void sendMessage(Message message,String t){
		try{
		System.out.println(t+"开始发送");
		oos.writeObject(message);
		oos.flush();
		System.out.println(t+"发送完毕");
		}catch(IOException e){
			e.printStackTrace();
		}
	}
	
	public synchronized Message getMessage(int expected_type,String t){ 
		try{
		System.out.println(t+"开始读取");
		if(message_list.size()==0) System.out.println("队列为空");
		else{
			for(Message m:message_list) System.out.print("队列大小"+message_list.size()+"队列元素"+m.type+" ");
			System.out.println("");
		}
		if(message_list.size()>=1){
			System.out.println("从队列中读取");
			Message m=message_list.get(0);
			if(m.type==expected_type){
				System.out.println("从队列中读取"+m.type+" "+expected_type+" "+message_list.size());
				message_list.remove(0);
				return m;
			}
		}
		else{
		Message back_msg=(Message)ois.readObject();
    	System.out.println("从流中读取"+back_msg.type+" "+expected_type);
		if(back_msg.type==expected_type)
			return back_msg;
		else
		    message_list.add(back_msg);
		}
		}catch(Exception e){
			e.printStackTrace();
		}
		System.out.println(t+"返回null");
		return null;
	}
	
}
