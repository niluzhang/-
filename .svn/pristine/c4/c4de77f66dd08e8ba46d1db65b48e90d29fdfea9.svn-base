package presentation_pkGameGUI;

import game.Position;
import gamemessage.CorpGetStateMessage;
import gamemessage.GameStateMessage;
import gamemessage.PkGameStateMessage;
import gamemessage.PkGetStateMessage;

import java.io.IOException;
import java.util.ArrayList;

import main.Startup;
import net.Net;

public class pkGameGUI_updateThread extends Thread {
	pkGameGUI game;
	public pkGameGUI_updateThread(pkGameGUI game){
		this.game=game;
	}
@Override
public void run(){
	while(true){
		
			synchronized (game.pVlock) {
				game.pVlock.notifyAll();
				try {
				sleep(5);
			} catch (InterruptedException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}
               game.isStateReceibe=false;
				// 发送项初始化 获取协作游戏状态 例如分数 时间
               if(game.iscansendstate){
            	   PkGetStateMessage sendms = new PkGetStateMessage();
				game.sendnumber++;
				System.out.println("gamestaet thread 开启");
				sendms.UserID = game.ID;
				// System.out.println("为何床布景区"+sendms.UserID);
				// &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&7&&&&&&&&&&77
				// 发送接受游戏状态的请求
				// 发送消息类型：121 发送给服务器 接受游戏状态请求
				Startup.net.sendMessage(sendms);
               
				// &&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
				// 接受游戏状态 来自服务器
				// 接受消息类型：100 返回的是游戏状态例如时间分数
				System.out.println("位置一");

				PkGameStateMessage message = (PkGameStateMessage) Startup.net
						.getMessage(118);
				System.out.println("接受kAISHI");

				// 数据的接受
				if (message != null) {
					game.isStateReceibe=true;
					game.receivenumber++;
					game.doublehitCount = message.gamestate.Lianji;
					game.doublehitState = message.gamestate.InSuperState;
					game.grade = message.gamestate.TotalGrade;
					game.time = message.gamestate.Time;
					if(message.gamestate.NeedUseTool_E){
						if(game.dropdirection==2){
						ArrayList<Position> psi=message.gamestate.Tool_E;
						game.remindx1=psi.get(0).Row;
						game.remindy1=psi.get(0).Column;
						game.remindx2=psi.get(1).Row;
						game.remindy2=psi.get(1).Column;
						}else{
							ArrayList<Position> psi=message.gamestate.Tool_E;
							game.remindy1=psi.get(0).Row;
							game.remindx1=psi.get(0).Column;
							game.remindy2=psi.get(1).Row;
							game.remindx2=psi.get(1).Column;	
						
					}
					}else{
						game.remindx1=-1;
						game.remindy1=-1;
						game.remindx2=-1;
						game.remindy2=-1;
					}
			//		game.cpgrade=message.pkgamestate.TotalGrade;
			//		game.doublehitState_cplayer=message.pkgamestate.InSuperState;
			//		game.doublehitCount_cplayer=message.pkgamestate.Lianji;
					
				} else {
					System.out.println("update thread 获取为空陷入等待");
					game.isStateReceibe=false;
				}

               }

				try {
					game.pVlock.wait();
				} catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
	}
}	
}
